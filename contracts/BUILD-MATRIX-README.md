# Smart Contract Build Matrix Testing

This directory contains the implementation of the smart contract build matrix testing framework, which validates compiler versions, optimizer settings, and Yul IR toggles.

## Overview

The build matrix testing framework ensures:
- Bytecode stability across different compiler versions and settings
- Optimization safety with various optimizer runs
- No undefined behavior in generated bytecode
- Consistent gas consumption patterns

## Prerequisites

Before running the build matrix tests, you need to install the following tools:

1. **Foundry**: A fast, portable, and modular toolkit for Ethereum application development
2. **Git**: For cloning dependencies

### Installing Foundry

To install Foundry, run the following command:

```bash
curl -L https://foundry.paradigm.xyz | bash
```

Then restart your terminal and run:

```bash
foundryup
```

### Installing Dependencies

To install contract dependencies, run:

```powershell
.\contracts\scripts\install-deps.ps1
```

This script will:
- Install OpenZeppelin Contracts
- Install Forge Standard Library
- Set up remappings

## Configuration

The build matrix is configured in `foundry.toml` with four distinct profiles:

1. **default**: Basic configuration with moderate optimization
2. **optimized**: Heavily optimized configuration
3. **ir**: Intermediate representation compilation
4. **ir-optimized**: Heavily optimized IR compilation

## Running Tests

### Running the Build Matrix Tests

To run the complete build matrix tests:

```powershell
.\scripts\run-build-matrix.ps1
```

This script will:
1. Build contracts with each configuration
2. Run tests to validate functionality
3. Generate gas snapshots
4. Compare bytecode between configurations
5. Produce detailed reports

### Running Individual Tests

To run tests for a specific profile:

```bash
cd contracts
forge test --profile default -vvv
forge test --profile optimized -vvv
forge test --profile ir -vvv
forge test --profile ir-optimized -vvv
```

### Building with Specific Compiler Versions

To build with specific Solidity compiler versions:

```bash
cd contracts
forge build --use solc:0.8.19
forge build --use solc:0.8.20
forge build --use solc:0.8.21
```

## Documentation

- [BUILD-MATRIX.md](docs/contracts/BUILD-MATRIX.md): Detailed documentation of the build matrix implementation
- [Foundry Configuration](foundry.toml): Configuration profiles for different build settings
- [Remappings](remappings.txt): Library remappings for contract imports

## CI/CD Integration

The build matrix tests are integrated into GitHub Actions through the workflow file:
- [.github/workflows/contract-build-matrix.yml](.github/workflows/contract-build-matrix.yml)

This workflow:
1. Tests all profile and compiler version combinations
2. Generates gas snapshots
3. Compares bytecode between configurations
4. Validates optimization benefits
5. Produces comprehensive reports

## Test Results

Test results and logs are stored in the `build-results` directory after running the build matrix tests:

- Build logs for each configuration
- Gas snapshots in JSON format
- Bytecode comparison reports
- Summary markdown report

## Troubleshooting

### Common Issues

1. **Foundry not found**: Ensure Foundry is installed and available in your PATH
2. **Dependency issues**: Run the dependency installation script
3. **Compilation errors**: Check contract syntax and Solidity version compatibility
4. **Test failures**: Review test output and contract logic

### Getting Help

If you encounter issues:
1. Check the detailed logs in the build-results directory
2. Verify all prerequisites are installed
3. Ensure dependencies are properly installed
4. Consult the documentation in [BUILD-MATRIX.md](docs/contracts/BUILD-MATRIX.md)

## Contributing

To contribute to the build matrix testing framework:

1. Follow the existing configuration patterns
2. Add new test cases to [BuildMatrixTest.sol](test/core/BuildMatrixTest.sol)
3. Update documentation as needed
4. Ensure all tests pass before submitting changes