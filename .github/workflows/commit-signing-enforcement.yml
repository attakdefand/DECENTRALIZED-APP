# Commit Signing Enforcement
# Enforces that all commits are signed and CI checks pass before merging

name: Commit Signing Enforcement

on:
  pull_request:
    branches: [ main, develop ]
    types: [ opened, synchronize, reopened ]
  push:
    branches: [ main ]

jobs:
  verify-signed-commits:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Fetch all history for all branches and tags

      - name: Set up PowerShell
        uses: actions/setup-powershell@v1

      - name: Install Git
        run: |
          sudo apt-get update
          sudo apt-get install -y git

      - name: Verify signed commits
        run: |
          # Get the commits in this PR or the latest commits on main
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            # For PRs, check commits between base and head
            COMMITS=$(git log --pretty=format:"%H %G?" ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }})
          else
            # For pushes to main, check last 10 commits
            COMMITS=$(git log --pretty=format:"%H %G?" -10)
          fi
          
          # Count total and signed commits
          TOTAL=0
          SIGNED=0
          
          echo "Checking commits:"
          while IFS= read -r line; do
            if [ -n "$line" ]; then
              TOTAL=$((TOTAL + 1))
              HASH=$(echo "$line" | cut -d' ' -f1)
              STATUS=$(echo "$line" | cut -d' ' -f2)
              
              echo "  $HASH: $STATUS"
              
              # Check if commit is signed (G or G? status)
              if [ "$STATUS" = "G" ]; then
                SIGNED=$((SIGNED + 1))
              fi
            fi
          done <<< "$COMMITS"
          
          # Calculate percentage
          if [ $TOTAL -eq 0 ]; then
            PCT=100
          else
            PCT=$((SIGNED * 100 / TOTAL))
          fi
          
          echo "Total commits: $TOTAL"
          echo "Signed commits: $SIGNED"
          echo "Signed commit percentage: $PCT%"
          
          # Check requirements
          if [ $PCT -lt 100 ]; then
            echo "ERROR: Signed commit percentage ($PCT%) is below minimum required (100%)"
            exit 1
          fi
          
          echo "PASS: All commits are signed"
        shell: bash

  check-ci-status:
    runs-on: ubuntu-latest
    needs: verify-signed-commits
    steps:
      - name: Check CI status
        run: |
          # In a real implementation, this would check the actual CI status
          # For now, we'll just check that required workflows have passed
          echo "Checking CI status..."
          
          # This is a simplified check - in practice, you would use the GitHub API
          # to check the status of required checks
          echo "CI status check placeholder"
          
          # For demonstration, we'll assume CI passes if we get here
          echo "PASS: Required CI checks have passed"

  enforce-governance:
    runs-on: ubuntu-latest
    needs: [verify-signed-commits, check-ci-status]
    if: always()
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Enforce governance rules
        run: |
          # Check the results of the previous jobs
          SIGNED_COMMITS_RESULT="${{ needs.verify-signed-commits.result }}"
          CI_STATUS_RESULT="${{ needs.check-ci-status.result }}"
          
          echo "Governance Enforcement Results:"
          echo "  Signed commits verification: $SIGNED_COMMITS_RESULT"
          echo "  CI status check: $CI_STATUS_RESULT"
          
          # Block if either check failed
          if [ "$SIGNED_COMMITS_RESULT" != "success" ] || [ "$CI_STATUS_RESULT" != "success" ]; then
            echo "BLOCK: Changes cannot be merged due to governance requirements"
            if [ "$SIGNED_COMMITS_RESULT" != "success" ]; then
              echo "  - Signed commits verification failed"
            fi
            if [ "$CI_STATUS_RESULT" != "success" ]; then
              echo "  - Required CI checks failed"
            fi
            exit 1
          else
            echo "PASS: All governance requirements satisfied"
          fi